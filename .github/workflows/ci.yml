name: CI - Build
on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Nome da imagem (sem o usuÃ¡rio/host). Ex: landingpage'
        required: false
        default: ''
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
      - '*'
jobs:
  build_image:
    name: Build and Push Docker image
    runs-on: ubuntu-latest
    env:
      REGISTRY_USER: ${{ secrets.REGISTRY_USER }}
      REGISTRY_PASS: ${{ secrets.REGISTRY_PASS }}
      # optional: set REGISTRY_HOST in repository secrets or variables (e.g. ghcr.io, docker.io)
      REGISTRY_HOST: ${{ secrets.REGISTRY_HOST }}
      # IMAGE_NAME priority: workflow input > repository var
      IMAGE_NAME: ${{ github.event.inputs.image_name || vars.IMAGE_NAME }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set short SHA
        run: echo "SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-8)" >> $GITHUB_ENV

      - name: Prepare image tags from ref
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            REF_NAME="${GITHUB_REF#refs/tags/}"
          else
            REF_NAME="${GITHUB_REF#refs/heads/}"
          fi
          # sanitize: replace slashes with dashes
          REF_NAME="${REF_NAME//\//-}"
          echo "REF_NAME=${REF_NAME}" >> $GITHUB_ENV

          # determine prefix (include registry host if provided)
          if [[ -n "${REGISTRY_HOST}" ]]; then
            PREFIX="${REGISTRY_HOST}/"
          else
            PREFIX=""
          fi

          # prepare tags using shell variables (avoid GitHub expressions inside run)
          echo "TAGS<<EOF" >> $GITHUB_ENV
          echo "${PREFIX}${REGISTRY_USER}/${IMAGE_NAME}:${SHORT_SHA}" >> $GITHUB_ENV
          echo "${PREFIX}${REGISTRY_USER}/${IMAGE_NAME}:${REF_NAME}" >> $GITHUB_ENV
          if [[ "${REF_NAME}" == "main" ]]; then
            echo "${PREFIX}${REGISTRY_USER}/${IMAGE_NAME}:latest" >> $GITHUB_ENV
          fi
          echo "EOF" >> $GITHUB_ENV

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to container registry (host provided)
        if: env.REGISTRY_HOST != ''
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY_HOST }}
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASS }}

      - name: Login to Docker Hub (no host provided)
        if: env.REGISTRY_HOST == ''
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASS }}

      - name: Build and push image
        uses: docker/build-push-action@v4
        with:
          context: ./app
          file: ./app/Dockerfile
          push: true
          tags: ${{ env.TAGS }}

